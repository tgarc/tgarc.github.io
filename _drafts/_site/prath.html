<div class="in_prompt">
In [1]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">&#39;ggplot&#39;</span><span class="p">)</span>

<span class="c"># This disables (the all-too-often falsely triggered) &#39;SettingWithCopyWarning&#39;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">chained_assignment</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># we promise we&#39;ll be careful</span>

<span class="k">print</span> <span class="s">&quot;pandas:&quot;</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">short_version</span>
<span class="k">print</span> <span class="s">&quot;numpy:&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">short_version</span></code></pre></div>

</div>

<div class="output_prompt">
Out [1]:
</div>

<pre><code>pandas: 0.16.2
numpy: 1.8.2
</code></pre>

<div class="in_prompt">
In [2]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;prath.sqlite&#39;</span><span class="p">)</span>
<span class="n">prath</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="s">&quot;select image_id,pixel_index,skin,r,g,b from pixels&quot;</span><span class="p">,</span><span class="n">conn</span><span class="p">)</span>

<span class="c"># index the dataframe by image_id and pixel_index for easier access and conversion to images</span>
<span class="n">prath</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s">&#39;image_id&#39;</span><span class="p">,</span><span class="s">&#39;pixel_index&#39;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">prath</span><span class="o">.</span><span class="n">sortlevel</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">prath</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>

</div>

<div class="output_prompt">
Out [2]:
</div>

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>skin</th>
      <th>r</th>
      <th>g</th>
      <th>b</th>
    </tr>
    <tr>
      <th>image_id</th>
      <th>pixel_index</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">0</th>
      <th>0</th>
      <td>0</td>
      <td>210</td>
      <td>205</td>
      <td>202</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>211</td>
      <td>206</td>
      <td>203</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>213</td>
      <td>208</td>
      <td>205</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>216</td>
      <td>211</td>
      <td>208</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>219</td>
      <td>214</td>
      <td>211</td>
    </tr>
  </tbody>
</table>
</div>

<div class="in_prompt">
In [3]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">images</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s">&quot;select * from images&quot;</span><span class="p">,</span><span class="n">conn</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="s">&#39;file_name&#39;</span><span class="p">)</span>
<span class="n">images</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>

</div>

<div class="output_prompt">
Out [3]:
</div>

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>image_id</th>
      <th>width</th>
      <th>height</th>
    </tr>
    <tr>
      <th>file_name</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>sri-lankan-actress-Natasha-Perera-</th>
      <td>0</td>
      <td>286</td>
      <td>400</td>
    </tr>
    <tr>
      <th>Megan-Fox-Pretty-Face-1-1024x768</th>
      <td>1</td>
      <td>512</td>
      <td>384</td>
    </tr>
    <tr>
      <th>Kishani_-__n_-_5</th>
      <td>2</td>
      <td>239</td>
      <td>320</td>
    </tr>
    <tr>
      <th>yamuna_erandathi</th>
      <td>3</td>
      <td>276</td>
      <td>400</td>
    </tr>
    <tr>
      <th>pg42RF</th>
      <td>4</td>
      <td>300</td>
      <td>362</td>
    </tr>
  </tbody>
</table>
</div>

<div class="in_prompt">
In [4]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c"># we&#39;re done loading data</span></code></pre></div>

</div>

<div class="in_prompt">
In [5]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">subplot_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">xticks</span><span class="o">=</span><span class="p">[],</span><span class="n">yticks</span><span class="o">=</span><span class="p">[]))</span>
<span class="n">sample_images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="k">for</span> <span class="n">fn</span><span class="p">,</span><span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sample_images</span><span class="p">,</span><span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()):</span>
    <span class="n">img_id</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fn</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">prath</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">img_id</span><span class="p">,),</span><span class="s">&#39;r&#39;</span><span class="p">:</span><span class="s">&#39;b&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">get_size_inches</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_size_inches</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code></pre></div>

</div>

<div class="output_prompt">
Out [5]:
</div>

<p><img src="/images/prath_4_0.png" alt="png" /></p>

<h1 id="lets-do-a-logit-fit-on-the-rgb-prath-dataset">Let’s do a logit fit on the RGB prath dataset</h1>

<div class="in_prompt">
In [6]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">predy</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;A simple report generator for evaluating model accuracy&#39;&#39;&#39;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="n">predy</span><span class="p">)</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span> <span class="o">!=</span> <span class="n">predy</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="bp">True</span><span class="p">))</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span> <span class="o">!=</span> <span class="n">predy</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="bp">False</span><span class="p">))</span>
    <span class="n">dispstr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">:</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%d</span><span class="s">/</span><span class="si">%d</span><span class="s"> (</span><span class="si">%.3f%%</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mf">100.0</span><span class="o">*</span><span class="n">m</span><span class="o">/</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">ret</span><span class="p">,</span> <span class="n">dispstr</span><span class="p">(</span><span class="s">&quot;Accuracy&quot;</span><span class="p">,</span> <span class="n">acc</span><span class="p">)</span>
    <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">ret</span><span class="p">,</span> <span class="n">dispstr</span><span class="p">(</span><span class="s">&quot;FN&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
    <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">ret</span><span class="p">,</span> <span class="n">dispstr</span><span class="p">(</span><span class="s">&quot;FP&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span></code></pre></div>

</div>

<div class="in_prompt">
In [7]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.cross_validation</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="n">clf_rgb</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
<span class="n">prath</span><span class="p">[</span><span class="s">&#39;r2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prath</span><span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
<span class="n">prath</span><span class="p">[</span><span class="s">&#39;g2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prath</span><span class="p">[</span><span class="s">&#39;g&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
<span class="n">prath</span><span class="p">[</span><span class="s">&#39;b2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prath</span><span class="p">[</span><span class="s">&#39;b&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
<span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">prath</span><span class="p">,</span><span class="n">train_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">get_rgb_features</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s">&#39;r&#39;</span><span class="p">:</span><span class="s">&#39;b2&#39;</span><span class="p">]</span>

<span class="k">print</span> <span class="n">clf_rgb</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">get_rgb_features</span><span class="p">(</span><span class="n">train</span><span class="p">),</span><span class="n">train</span><span class="p">[</span><span class="s">&#39;skin&#39;</span><span class="p">])</span>
<span class="k">print</span> <span class="n">report</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">skin</span><span class="p">,</span> <span class="n">clf_rgb</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">get_rgb_features</span><span class="p">(</span><span class="n">test</span><span class="p">)))</span></code></pre></div>

</div>

<div class="output_prompt">
Out [7]:
</div>

<pre><code>LogisticRegression(C=0.001, class_weight=None, dual=False, fit_intercept=True,
          intercept_scaling=1, max_iter=100, multi_class='ovr',
          penalty='l2', random_state=None, solver='liblinear', tol=0.0001,
          verbose=0)
Accuracy: 2187240/2956654 (73.977%)
FN: 530492/2956654 (17.942%)
FP: 238922/2956654 (8.081%)
</code></pre>

<h1 id="lets-try-to-test-the-classifier-on-an-example-image">Let’s try to test the classifier on an example image…</h1>

<div class="in_prompt">
In [8]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">plot_thresh</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">predimg</span><span class="p">,</span><span class="n">mask</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Display the results of applying a skin pixel classifier to an image&#39;&#39;&#39;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">ax3</span><span class="p">,</span><span class="n">ax4</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">subplot_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">xticks</span><span class="o">=</span><span class="p">[],</span><span class="n">yticks</span><span class="o">=</span><span class="p">[]))</span>
    
    <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">predimg</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;backprojection&#39;</span><span class="p">)</span>
    <span class="n">threshimg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">threshimg</span><span class="p">[</span><span class="n">predimg</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">threshimg</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;threshold&#39;</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;ground truth&#39;</span><span class="p">)</span></code></pre></div>

</div>

<div class="in_prompt">
In [9]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_image</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Helper function to get an rgb image from its name&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="nb">basestring</span><span class="p">):</span>
        <span class="n">img_id</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fn</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">img_id</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">images</span><span class="o">.</span><span class="n">image_id</span><span class="o">==</span><span class="n">fn</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">prath</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">img_id</span><span class="p">,),:]</span>
    
    <span class="c"># the .values property is not totally dependable. But it works in this instance</span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s">&#39;r&#39;</span><span class="p">:</span><span class="s">&#39;b&#39;</span><span class="p">]</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span><span class="p">,</span><span class="n">img</span></code></pre></div>

</div>

<div class="in_prompt">
In [10]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">buffydf</span><span class="p">,</span> <span class="n">buffy</span> <span class="o">=</span> <span class="n">get_image</span><span class="p">(</span><span class="s">&#39;06Apr03Face&#39;</span><span class="p">)</span>
<span class="n">buffydf</span><span class="p">[</span><span class="s">&#39;r2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffydf</span><span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
<span class="n">buffydf</span><span class="p">[</span><span class="s">&#39;g2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffydf</span><span class="p">[</span><span class="s">&#39;g&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
<span class="n">buffydf</span><span class="p">[</span><span class="s">&#39;b2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffydf</span><span class="p">[</span><span class="s">&#39;b&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

<span class="n">pred</span> <span class="o">=</span> <span class="n">clf_rgb</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">get_rgb_features</span><span class="p">(</span><span class="n">buffydf</span><span class="p">))[:,</span><span class="mi">1</span><span class="p">]</span> <span class="c"># select only the skin=True probability</span>
<span class="n">predimg</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">buffy</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">buffydf</span><span class="p">[</span><span class="s">&#39;skin&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

<span class="n">plot_thresh</span><span class="p">(</span><span class="n">buffy</span><span class="p">,</span><span class="n">predimg</span><span class="p">,</span><span class="n">mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">buffy</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span></code></pre></div>

</div>

<div class="output_prompt">
Out [10]:
</div>

<p><img src="/images/prath_11_0.png" alt="png" /></p>

<h1 id="lets-explore-skin-pixels-in-the-ycrcb-colorspace">Let’s explore skin pixels in the YCrCb colorspace</h1>

<div class="in_prompt">
In [11]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">add_crcb</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="c"># grabbed from http://www.equasys.de/colorconversion.html</span>
    <span class="n">df</span><span class="p">[</span><span class="s">&#39;Y&#39;</span><span class="p">]</span> <span class="o">=</span>   <span class="mf">0.299</span>  <span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.587</span>  <span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;g&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.114</span>  <span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;b&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s">&#39;Cr&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">0.5</span>    <span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.419</span>  <span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;g&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.081</span>  <span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;b&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">128</span>
    <span class="n">df</span><span class="p">[</span><span class="s">&#39;Cb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.169</span>  <span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.331</span>  <span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;g&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span>    <span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;b&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">128</span>
<span class="n">add_crcb</span><span class="p">(</span><span class="n">prath</span><span class="p">)</span></code></pre></div>

</div>

<div class="in_prompt">
In [12]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">plot_density</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">colorbar</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">H</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">H</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">H</span><span class="p">,</span> <span class="n">xedges</span><span class="p">,</span> <span class="n">yedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;Cr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s">&#39;Cb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">257</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xedges</span> <span class="o">=</span> <span class="n">yedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">257</span><span class="p">)</span>

    <span class="c"># flip the histogram axes so plot displays CrCb values propery</span>
    <span class="n">Hp</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">T</span>
    
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">xedges</span><span class="p">,</span><span class="n">yedges</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">Hp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span><span class="n">Hp</span><span class="p">,</span><span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">colorbar</span><span class="p">:</span> <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;Cr&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Cb&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">115</span><span class="p">,</span><span class="mi">205</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span><span class="mi">145</span><span class="p">);</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">H</span></code></pre></div>

</div>

<div class="in_prompt">
In [13]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;CrCb Skin pixel distribution&#39;</span><span class="p">)</span>

<span class="c"># be nice to numpy and give it a singly indexed dataframe</span>
<span class="n">Hs</span> <span class="o">=</span> <span class="n">plot_density</span><span class="p">(</span><span class="n">prath</span><span class="p">[</span><span class="n">prath</span><span class="o">.</span><span class="n">skin</span><span class="o">==</span><span class="mi">1</span><span class="p">])</span>

<span class="c"># note: we add 1 extra bin to the histogram to avoid binning together values of 254 and 255 </span>
<span class="c">#(see notes on numpy doc http://docs.scipy.org/doc/numpy/reference/generated/numpy.histogram.html)</span>
<span class="n">Hns</span><span class="p">,</span> <span class="n">xedges</span><span class="p">,</span> <span class="n">yedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">prath</span><span class="p">[</span><span class="n">prath</span><span class="o">.</span><span class="n">skin</span><span class="o">==</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;Cr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">prath</span><span class="p">[</span><span class="n">prath</span><span class="o">.</span><span class="n">skin</span><span class="o">==</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;Cb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">257</span><span class="p">))</span>
<span class="n">Hdiff</span> <span class="o">=</span> <span class="n">Hs</span><span class="o">-</span><span class="n">Hns</span>

<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Skin pixels - Non-skin pixels&#39;</span><span class="p">)</span>
<span class="n">plot_density</span><span class="p">(</span><span class="n">H</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">Hdiff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Hs</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">get_size_inches</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_size_inches</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="k">print</span> <span class="s">&quot;Uniquely seperable skin/non-skin pixels: </span><span class="se">\n\t</span><span class="si">%.2f</span><span class="s"> </span><span class="si">%%</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Hs</span><span class="p">[</span><span class="n">Hns</span><span class="o">==</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Hns</span><span class="p">[</span><span class="n">Hs</span><span class="o">==</span><span class="mi">0</span><span class="p">]))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">prath</span><span class="p">))</span>

<span class="c"># Create a dataframe with the counts for each CrCb value</span>
<span class="n">crcbspace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[:</span><span class="mi">256</span><span class="p">,:</span><span class="mi">256</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">counts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">crcbspace</span><span class="p">,</span><span class="n">Hdiff</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))),</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;Cr&#39;</span><span class="p">,</span><span class="s">&#39;Cb&#39;</span><span class="p">,</span><span class="s">&#39;n&#39;</span><span class="p">])</span>
<span class="n">merged</span> <span class="o">=</span> <span class="n">prath</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;Cr&#39;</span><span class="p">,</span><span class="s">&#39;Cb&#39;</span><span class="p">],</span><span class="n">how</span><span class="o">=</span><span class="s">&#39;outer&#39;</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;Majority Thresholding classifier&quot;</span>
<span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report</span><span class="p">(</span><span class="n">merged</span><span class="o">.</span><span class="n">skin</span><span class="p">,</span><span class="n">merged</span><span class="o">.</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span></code></pre></div>

</div>

<div class="output_prompt">
Out [13]:
</div>

<pre><code>Uniquely seperable skin/non-skin pixels: 
	10.61 %
Majority Thresholding classifier
	Accuracy: 4361413/5978842 (72.947%)
	FN: 1551894/5978842 (25.956%)
	FP: 0/5978842 (0.000%)
</code></pre>

<p><img src="/images/prath_15_1.png" alt="png" /></p>

<blockquote>
  <p>The plot above empirically shows that only a small minority (~10.6%) of pixels
  in the CrCb pixels can be uniquely separated into skin and non-skin
  pixels. It’s also shown that if we were to build a rudimentary classifier,
  assigning category based on a majority vote of skin and non-skin pixels for
  that value, we could achieve a classification accuracy of about 87%.</p>
</blockquote>

<h1 id="lets-try-fitting-a-logit-model-to-the-crcb-skin-pixels">Let’s try fitting a logit model to the CrCb skin pixels</h1>

<div class="in_prompt">
In [14]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">prath</span><span class="p">[</span><span class="s">&#39;Cr2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prath</span><span class="p">[</span><span class="s">&#39;Cr&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
<span class="n">prath</span><span class="p">[</span><span class="s">&#39;Cb2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prath</span><span class="p">[</span><span class="s">&#39;Cb&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
<span class="n">prath</span><span class="p">[</span><span class="s">&#39;CrCb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prath</span><span class="p">[</span><span class="s">&#39;Cr&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">prath</span><span class="p">[</span><span class="s">&#39;Cb&#39;</span><span class="p">]</span>

<span class="n">clf_crcb</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">prath</span><span class="p">,</span><span class="n">train_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">get_ycc_features</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s">&#39;Cr&#39;</span><span class="p">:</span><span class="s">&#39;CrCb&#39;</span><span class="p">]</span>

<span class="k">print</span> <span class="n">clf_crcb</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">get_ycc_features</span><span class="p">(</span><span class="n">train</span><span class="p">),</span><span class="n">train</span><span class="o">.</span><span class="n">skin</span><span class="p">)</span>
<span class="k">print</span> <span class="n">report</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">skin</span><span class="p">,</span> <span class="n">clf_crcb</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">get_ycc_features</span><span class="p">(</span><span class="n">test</span><span class="p">)))</span></code></pre></div>

</div>

<div class="output_prompt">
Out [14]:
</div>

<pre><code>LogisticRegression(C=1, class_weight=None, dual=False, fit_intercept=True,
          intercept_scaling=1, max_iter=100, multi_class='ovr',
          penalty='l2', random_state=None, solver='liblinear', tol=0.0001,
          verbose=0)
Accuracy: 2376592/2956654 (80.381%)
FN: 308338/2956654 (10.429%)
FP: 271724/2956654 (9.190%)
</code></pre>

<h3 id="lets-see-how-it-performs-on-our-test-image">Let’s see how it performs on our test image.</h3>

<div class="in_prompt">
In [15]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">add_crcb</span><span class="p">(</span><span class="n">buffydf</span><span class="p">)</span>
<span class="n">buffydf</span><span class="p">[</span><span class="s">&#39;Cr2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffydf</span><span class="p">[</span><span class="s">&#39;Cr&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
<span class="n">buffydf</span><span class="p">[</span><span class="s">&#39;Cb2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffydf</span><span class="p">[</span><span class="s">&#39;Cb&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
<span class="n">buffydf</span><span class="p">[</span><span class="s">&#39;CrCb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffydf</span><span class="p">[</span><span class="s">&#39;Cr&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">buffydf</span><span class="p">[</span><span class="s">&#39;Cb&#39;</span><span class="p">]</span></code></pre></div>

</div>

<div class="in_prompt">
In [16]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">pred</span> <span class="o">=</span> <span class="n">clf_crcb</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">get_ycc_features</span><span class="p">(</span><span class="n">buffydf</span><span class="p">))[:,</span><span class="mi">1</span><span class="p">]</span> <span class="c"># select only the skin=True probability</span>
<span class="n">predimg</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">buffy</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>

<span class="n">plot_thresh</span><span class="p">(</span><span class="n">buffy</span><span class="p">,</span><span class="n">predimg</span><span class="p">,(</span><span class="n">buffydf</span><span class="p">[</span><span class="s">&#39;skin&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">buffy</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span></code></pre></div>

</div>

<div class="output_prompt">
Out [16]:
</div>

<p><img src="/images/prath_21_0.png" alt="png" /></p>

<div class="in_prompt">
In [36]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">hard_thresh</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">150</span><span class="p">,</span><span class="mi">180</span><span class="p">),(</span><span class="mi">85</span><span class="p">,</span><span class="mi">115</span><span class="p">)]</span>
<span class="k">def</span> <span class="nf">skinthresh</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">thresh</span><span class="p">):</span>
    <span class="p">(</span><span class="n">cr_lo</span><span class="p">,</span><span class="n">cr_hi</span><span class="p">),(</span><span class="n">cb_lo</span><span class="p">,</span><span class="n">cb_hi</span><span class="p">)</span> <span class="o">=</span> <span class="n">thresh</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">cr_lo</span> <span class="o">&lt;=</span> <span class="n">ds</span><span class="p">[</span><span class="s">&#39;Cr&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s">&#39;Cr&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">cr_hi</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cb_lo</span> <span class="o">&lt;=</span> <span class="n">ds</span><span class="p">[</span><span class="s">&#39;Cb&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cb_hi</span> <span class="o">&lt;=</span> <span class="n">ds</span><span class="p">[</span><span class="s">&#39;Cb&#39;</span><span class="p">])</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">skinthresh</span><span class="p">(</span><span class="n">test</span><span class="p">,</span><span class="n">hard_thresh</span><span class="p">)</span>
<span class="k">print</span> <span class="n">report</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">skin</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span></code></pre></div>

</div>

<div class="output_prompt">
Out [36]:
</div>

<pre><code>Accuracy: 2141119/2956654 (72.417%)
FN: 769001/2956654 (26.009%)
FP: 46534/2956654 (1.574%)
</code></pre>

<div class="in_prompt">
In [33]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">predimg</span> <span class="o">=</span> <span class="n">skinthresh</span><span class="p">(</span><span class="n">buffydf</span><span class="p">,</span><span class="n">hard_thresh</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">buffy</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
<span class="n">plot_thresh</span><span class="p">(</span><span class="n">buffy</span><span class="p">,</span><span class="n">predimg</span><span class="p">,(</span><span class="n">buffydf</span><span class="p">[</span><span class="s">&#39;skin&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">buffy</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span></code></pre></div>

</div>

<div class="output_prompt">
Out [33]:
</div>

<p><img src="/images/prath_23_0.png" alt="png" /></p>

<h3 id="lets-look-at-the-decision-boundary">Let’s look at the decision boundary</h3>

<div class="in_prompt">
In [19]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">decision_bound</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">intercept_</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
    <span class="n">subset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    
    <span class="n">X</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">subset</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="s">&#39;Cr&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span><span class="n">X</span><span class="p">[</span><span class="s">&#39;Cb&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span><span class="s">&#39;o&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Skin&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="s">&#39;Cr&#39;</span><span class="p">][</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span><span class="n">X</span><span class="p">[</span><span class="s">&#39;Cb&#39;</span><span class="p">][</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span><span class="s">&#39;o&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;NonSkin&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;Cr&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Cb&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">115</span><span class="p">,</span><span class="mi">205</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span><span class="mi">145</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span></code></pre></div>

</div>

<div class="in_prompt">
In [37]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">fig</span><span class="p">,(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">1000</span> <span class="c"># sqrt of the number of points to use for the grid</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">clf_crcb</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="c"># evaluate the decision function over a (sparse) grid of points</span>
<span class="n">cr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">prath</span><span class="p">[</span><span class="s">&#39;Cr&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">prath</span><span class="p">[</span><span class="s">&#39;Cr&#39;</span><span class="p">]),</span><span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">prath</span><span class="p">[</span><span class="s">&#39;Cb&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">prath</span><span class="p">[</span><span class="s">&#39;Cb&#39;</span><span class="p">]),</span><span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">cr</span> <span class="o">+</span> <span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">cb</span> <span class="o">+</span> <span class="n">theta</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">cr</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">theta</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">cb</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">theta</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">cr</span><span class="o">*</span><span class="n">cb</span> <span class="o">+</span> <span class="n">clf_crcb</span><span class="o">.</span><span class="n">intercept_</span>

<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">decision_bound</span><span class="p">(</span><span class="n">clf_crcb</span><span class="p">,</span><span class="n">train</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s">&#39;Cr&#39;</span><span class="p">:</span><span class="s">&#39;Cb&#39;</span><span class="p">],</span><span class="n">train</span><span class="o">.</span><span class="n">skin</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">30000</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">cb</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">z</span><span class="p">,[</span><span class="mi">0</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Logit&#39;</span><span class="p">,</span><span class="n">linewidths</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">plot_density</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="o">.</span><span class="n">skin</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">colorbar</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">cb</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">z</span><span class="p">,[</span><span class="mi">0</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Logit&#39;</span><span class="p">,</span><span class="n">linewidths</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hard_thresh</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hard_thresh</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">([</span><span class="n">x1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">x1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s">&#39;dashed&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;m&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Threshold&#39;</span><span class="p">))</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">([</span><span class="n">x1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">x1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s">&#39;dashed&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;m&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Threshold&#39;</span><span class="p">))</span>

<span class="n">line_proxy</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],[],</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s">&#39;solid&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">+</span><span class="p">[</span><span class="n">line_proxy</span><span class="p">],</span><span class="n">labels</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;Logit&#39;</span><span class="p">])</span>

<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">+</span><span class="p">[</span><span class="n">line_proxy</span><span class="p">],</span><span class="n">labels</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;Logit&#39;</span><span class="p">])</span>

<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">get_size_inches</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_size_inches</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1.25</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span></code></pre></div>

</div>

<div class="output_prompt">
Out [37]:
</div>

<p><img src="/images/prath_26_0.png" alt="png" /></p>

<h1 id="lets-explore-a-few-different-skin-profiles">Let’s explore a few different skin profiles</h1>

<div class="in_prompt">
In [21]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">sample_images</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Srilankan-Actress-Yamuna-Erandathi-001&#39;</span><span class="p">,</span><span class="s">&#39;06Apr03Face&#39;</span><span class="p">,</span><span class="s">&#39;pg42RF&#39;</span><span class="p">,</span><span class="s">&#39;dulani_anuradha4&#39;</span><span class="p">,</span><span class="s">&#39;Matthew_narrowweb__300x381,0&#39;</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_images</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">fn</span><span class="p">,(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sample_images</span><span class="p">,</span><span class="n">axes</span><span class="p">):</span>
    <span class="n">df</span><span class="p">,</span><span class="n">img</span> <span class="o">=</span> <span class="n">get_image</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">add_crcb</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">);</span><span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([]),</span><span class="n">ax1</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">fn</span><span class="p">[:</span><span class="mi">12</span><span class="p">])</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax2</span><span class="p">)</span>
    <span class="n">plot_density</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">skin</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span><span class="n">colorbar</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">tick_right</span><span class="p">();</span> <span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s">&quot;right&quot;</span><span class="p">)</span>
    
<span class="n">axes</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Skin Pixel Distributions&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">get_size_inches</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_size_inches</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>

<span class="n">n_clusters</span><span class="o">=</span><span class="mi">4</span>
<span class="n">km</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">,</span><span class="n">n_init</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">skin</span> <span class="o">=</span> <span class="n">prath</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">prath</span><span class="o">.</span><span class="n">skin</span><span class="o">==</span><span class="mi">1</span><span class="p">,:]</span>
<span class="n">km</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">skin</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s">&#39;Cr&#39;</span><span class="p">:</span><span class="s">&#39;Cb&#39;</span><span class="p">])</span>
<span class="n">skin</span><span class="p">[</span><span class="s">&#39;cluster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">km</span><span class="o">.</span><span class="n">labels_</span></code></pre></div>

</div>

<div class="output_prompt">
Out [21]:
</div>

<p><img src="/images/prath_28_0.png" alt="png" /></p>

<div class="in_prompt">
In [23]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">cr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">prath</span><span class="p">[</span><span class="s">&#39;Cr&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">prath</span><span class="p">[</span><span class="s">&#39;Cr&#39;</span><span class="p">]),</span><span class="n">N</span><span class="p">)</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">prath</span><span class="p">[</span><span class="s">&#39;Cb&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">prath</span><span class="p">[</span><span class="s">&#39;Cb&#39;</span><span class="p">]),</span><span class="n">N</span><span class="p">)</span>

<span class="c"># evaluate the labels over a grid</span>
<span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span><span class="n">cb</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">km</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>

<span class="c"># Put the result into a color plot</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">plot_density</span><span class="p">(</span><span class="n">skin</span><span class="p">,</span><span class="n">colorbar</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Paired</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">centroids</span> <span class="o">=</span> <span class="n">km</span><span class="o">.</span><span class="n">cluster_centers_</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">centroids</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">centroids</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">marker</span><span class="o">=</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s">&#39;0.75&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">mean</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">centroids</span><span class="p">):</span> <span class="k">print</span> <span class="s">&quot;Cluster #{} = {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">mean</span><span class="p">)</span></code></pre></div>

</div>

<div class="output_prompt">
Out [23]:
</div>

<pre><code>Cluster #0 = [ 150.85660996  107.708975  ]
Cluster #1 = [ 139.21217822  117.20015359]
Cluster #2 = [ 171.8830747   91.7016004]
Cluster #3 = [ 160.39891208  100.70770297]
</code></pre>

<p><img src="/images/prath_29_1.png" alt="png" /></p>

<div class="in_prompt">
In [24]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">pshape</span><span class="o">=</span><span class="p">[</span><span class="mi">180</span><span class="p">,</span><span class="mi">240</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span><span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n_clusters</span><span class="p">,</span><span class="n">subplot_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">xticks</span><span class="o">=</span><span class="p">[],</span><span class="n">yticks</span><span class="o">=</span><span class="p">[]))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    
    <span class="n">clusterp</span> <span class="o">=</span> <span class="n">skin</span><span class="p">[</span><span class="n">skin</span><span class="p">[</span><span class="s">&#39;cluster&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>
    <span class="n">rsamp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">clusterp</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">pshape</span><span class="p">),</span><span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="n">clusterp</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">rsamp</span><span class="p">]</span>
    
    <span class="n">patch</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;Y&#39;</span><span class="p">])</span> <span class="c">#sort by luminance value &#39;Y&#39; for display purposes</span>
    
    <span class="n">imgpatch</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s">&#39;r&#39;</span><span class="p">:</span><span class="s">&#39;b&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pshape</span><span class="o">+</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imgpatch</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Skin Cluster #</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
    
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">get_size_inches</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_size_inches</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code></pre></div>

</div>

<div class="output_prompt">
Out [24]:
</div>

<p><img src="/images/prath_30_0.png" alt="png" /></p>

<div class="in_prompt">
In [25]:
</div>

<div class="inner_cell">

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">sample_images</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Srilankan-Actress-Yamuna-Erandathi-001&#39;</span><span class="p">,</span><span class="s">&#39;06Apr03Face&#39;</span><span class="p">,</span><span class="s">&#39;pg42RF&#39;</span><span class="p">,</span><span class="s">&#39;dulani_anuradha4&#39;</span><span class="p">,</span><span class="s">&#39;Matthew_narrowweb__300x381,0&#39;</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_images</span><span class="p">),</span><span class="n">n_clusters</span><span class="p">,</span><span class="n">subplot_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">xticks</span><span class="o">=</span><span class="p">[],</span><span class="n">yticks</span><span class="o">=</span><span class="p">[]))</span>
<span class="k">for</span> <span class="n">fn</span><span class="p">,</span><span class="n">subaxes</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sample_images</span><span class="p">,</span><span class="n">axes</span><span class="p">):</span>
    <span class="n">imgid</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fn</span><span class="p">]</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">prath</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">imgid</span><span class="p">,),</span><span class="s">&#39;r&#39;</span><span class="p">:</span><span class="s">&#39;b&#39;</span><span class="p">]</span>
    <span class="n">skindf</span> <span class="o">=</span> <span class="n">skin</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">imgid</span><span class="p">,),</span><span class="s">&#39;cluster&#39;</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">skindf</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">)</span> <span class="c"># join skin cluster labels with rgb pixels</span>

    <span class="n">cluster</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">cluster</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s">&#39;cluster&#39;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subaxes</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">img</span><span class="p">[</span><span class="n">cluster</span> <span class="o">!=</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>    
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">n_clusters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">fn</span><span class="p">[:</span><span class="mi">12</span><span class="p">])</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">):</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Skin cluster #</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">get_size_inches</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_size_inches</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code></pre></div>

</div>

<div class="output_prompt">
Out [25]:
</div>

<p><img src="/images/prath_31_0.png" alt="png" /></p>

<div class="in_prompt">
In [None]:
</div>

<div class="inner_cell">



</div>
